# 🔧 密碼重設功能修復與測試指南

## 📋 問題描述

**日期**: 2025-11-08  
**問題**: 成功收到郵件，但無法成功更改密碼  
**狀態**: ✅ 已修復

---

## ✅ 已完成的修復

### 1. 修復表單 Token 欄位衝突

**問題**:
```html
<!-- ❌ 錯誤：同時使用 th:value 和 th:field 會導致衝突 -->
<input type="hidden" name="token" th:value="${token}" th:field="*{token}">
```

**修復**:
```html
<!-- ✅ 正確：只使用 th:value -->
<input type="hidden" name="token" th:value="${token}">
```

### 2. 添加成功訊息顯示

**新增**:
```html
<!-- 成功訊息 -->
<div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
```

### 3. 增強日誌輸出

在 `UserProfileController` 中添加詳細的調試日誌：
- Token 值
- 密碼長度
- 驗證錯誤詳情
- 成功/失敗狀態

---

## 🧪 測試步驟

### 完整測試流程

#### 步驟 1: 請求重設密碼

1. **訪問忘記密碼頁面**
   ```
   http://localhost:8080/user/forgot-password
   ```

2. **輸入 Email**
   - 輸入: `howie960018@gmail.com`
   - 點擊「發送重設連結」

3. **驗證後台日誌**
   應該看到：
   ```
   INFO  c.e.b.service.UserService  : 為電子郵件 howie960018@gmail.com 生成密碼重設令牌
   INFO  c.e.b.service.EmailService : HTML 郵件已發送至 howie960018@gmail.com
   INFO  c.e.b.service.UserService  : 密碼重設郵件發送成功至 howie960018@gmail.com
   ```

#### 步驟 2: 檢查郵件

1. **登入 Gmail**
   - 前往 https://mail.google.com

2. **查找重設密碼郵件**
   - 主旨：「【訂房系統】密碼重設通知」
   - 如果收件匣沒有，檢查垃圾郵件

3. **驗證郵件內容**
   - 應該有漂亮的 HTML 排版
   - 有「🔒 重設密碼」按鈕
   - 有備用連結

#### 步驟 3: 重設密碼

1. **點擊郵件中的按鈕**
   - 或複製連結到瀏覽器

2. **驗證頁面載入**
   - 應該看到「重設密碼」頁面
   - 有密碼要求清單
   - 有新密碼和確認密碼輸入框

3. **輸入新密碼**
   - 新密碼：`newpass123`（至少 6 字元）
   - 確認密碼：`newpass123`

4. **驗證即時反饋**
   - 密碼強度指示器應該顯示
   - 密碼一致性應該顯示「✓ 密碼一致」
   - 提交按鈕應該啟用

5. **提交表單**
   - 點擊「🔓 重設密碼」按鈕

#### 步驟 4: 驗證後台日誌

**成功的日誌**:
```
=== 重設密碼請求 ===
Token: xxx-xxx-xxx
新密碼長度: 11
確認密碼長度: 11
驗證錯誤: false
INFO  c.e.b.service.UserService : 使用令牌重設密碼
INFO  c.e.b.service.UserService : 用戶 user1 密碼重設成功
密碼重設成功！
```

**失敗的日誌**（如果有問題）:
```
=== 重設密碼請求 ===
Token: xxx-xxx-xxx
驗證錯誤: true
驗證錯誤詳情: [...]
```
或
```
密碼重設失敗: [錯誤訊息]
[堆疊追蹤]
```

#### 步驟 5: 驗證登入

1. **重定向到登入頁面**
   - 應該自動重定向到 `/login`
   - 應該看到成功訊息：「密碼重設成功，請使用新密碼登入」

2. **使用新密碼登入**
   - 帳號：`user1`
   - 密碼：`newpass123`（新密碼）
   - 點擊登入

3. **驗證登入成功**
   - 應該成功登入
   - 跳轉到首頁或相應的儀表板

---

## 🐛 可能的問題與解決方案

### 問題 1: 提交後顯示「資料驗證失敗」

**原因**: 表單驗證錯誤

**檢查日誌**:
```
驗證錯誤: true
驗證錯誤詳情: [...]
```

**解決方案**:
- 確認密碼至少 6 字元
- 確認兩次密碼輸入一致
- 檢查是否有特殊字元問題

### 問題 2: 提交後顯示「無效的重設令牌」

**原因**: 令牌不存在或已過期

**解決方案**:
- 重新請求重設密碼
- 確認令牌在 24 小時內使用
- 確認令牌沒有被重複使用

### 問題 3: 提交後顯示「重設令牌已過期」

**原因**: 超過 24 小時

**解決方案**:
- 返回忘記密碼頁面
- 重新請求新的重設連結

### 問題 4: 提交後顯示「新密碼與確認密碼不一致」

**原因**: 兩次密碼輸入不同

**解決方案**:
- 確認兩次輸入完全一致
- 注意大小寫
- 檢查是否有多餘的空格

### 問題 5: 頁面白屏或 500 錯誤

**檢查日誌**:
```
密碼重設失敗: [錯誤訊息]
[堆疊追蹤]
```

**解決方案**:
- 複製完整錯誤訊息
- 檢查堆疊追蹤
- 確認資料庫連接正常

---

## 📊 測試檢查清單

### 基本功能測試

- [ ] **請求重設密碼**
  - [ ] 可以訪問忘記密碼頁面
  - [ ] 可以輸入 Email
  - [ ] 成功提交表單
  - [ ] 看到成功訊息

- [ ] **接收郵件**
  - [ ] 收到重設密碼郵件
  - [ ] 郵件格式正確（HTML）
  - [ ] 按鈕可以點擊
  - [ ] 備用連結正確

- [ ] **重設密碼頁面**
  - [ ] 頁面正常載入
  - [ ] 密碼要求清單顯示
  - [ ] 密碼強度檢測運作
  - [ ] 一致性驗證運作
  - [ ] 提交按鈕動態啟用

- [ ] **提交重設**
  - [ ] 可以提交表單
  - [ ] 看到成功訊息或錯誤訊息
  - [ ] 成功時重定向到登入頁面

- [ ] **使用新密碼登入**
  - [ ] 新密碼可以登入
  - [ ] 舊密碼無法登入

### 錯誤處理測試

- [ ] **密碼長度不足**
  - [ ] 輸入少於 6 字元
  - [ ] 提交按鈕保持禁用
  - [ ] 或顯示驗證錯誤

- [ ] **密碼不一致**
  - [ ] 兩次輸入不同密碼
  - [ ] 顯示「密碼不一致」
  - [ ] 提交按鈕保持禁用

- [ ] **無效令牌**
  - [ ] 使用錯誤的 token
  - [ ] 重定向到忘記密碼頁面
  - [ ] 顯示錯誤訊息

- [ ] **過期令牌**
  - [ ] 使用 24 小時前的 token
  - [ ] 顯示「令牌已過期」
  - [ ] 提示重新請求

### 安全性測試

- [ ] **令牌單次使用**
  - [ ] 成功重設後，令牌應被清除
  - [ ] 同一令牌無法再次使用

- [ ] **密碼加密**
  - [ ] 檢查資料庫中的密碼是否加密
  - [ ] 新密碼應該是 BCrypt 格式

- [ ] **舊密碼失效**
  - [ ] 重設後，舊密碼無法登入
  - [ ] 只有新密碼可以登入

---

## 🔍 調試技巧

### 查看詳細日誌

**後台日誌應該包含**:
```
=== 重設密碼請求 ===
Token: [token值]
新密碼長度: [數字]
確認密碼長度: [數字]
驗證錯誤: [true/false]
```

### 檢查資料庫

**查詢用戶的重設令牌**:
```sql
SELECT username, email, reset_token, reset_token_expiry 
FROM users 
WHERE email = 'howie960018@gmail.com';
```

**驗證密碼是否更新**:
```sql
SELECT username, password, updated_at 
FROM users 
WHERE username = 'user1';
```

**檢查令牌是否清除**:
```sql
-- 重設成功後，reset_token 應該是 NULL
SELECT username, reset_token, reset_token_expiry 
FROM users 
WHERE username = 'user1';
```

### 瀏覽器開發者工具

**檢查表單提交**:
1. 打開開發者工具（F12）
2. 切換到 Network 標籤
3. 提交表單
4. 檢查 POST 請求
5. 查看請求參數和回應

**應該看到**:
```
Request URL: http://localhost:8080/user/reset-password
Request Method: POST
Form Data:
  token: xxx-xxx-xxx
  newPassword: ***
  confirmPassword: ***
  _csrf: xxx
```

---

## 📝 常見問題 FAQ

### Q1: 為什麼修改了 token 欄位？

**A**: 原本的代碼同時使用了 `th:value` 和 `th:field`，這會導致衝突。Thymeleaf 會不確定應該使用哪個值。

### Q2: 如何確認密碼已成功更改？

**A**: 
1. 查看後台日誌，應該有「密碼重設成功」
2. 使用新密碼登入
3. 確認舊密碼無法登入

### Q3: 令牌的有效期是多久？

**A**: 24 小時。在 `UserService.generateResetToken()` 中設定：
```java
user.setResetTokenExpiry(LocalDateTime.now().plusHours(24));
```

### Q4: 為什麼添加了這麼多日誌？

**A**: 為了方便調試。如果重設失敗，可以從日誌中看到：
- Token 是否正確傳遞
- 密碼是否符合要求
- 驗證在哪個步驟失敗

### Q5: 郵件中的連結點擊後為什麼要重新驗證 token？

**A**: 安全考量。即使連結被攔截，也需要在提交時再次驗證 token 是否有效、是否過期。

---

## ✨ 測試成功的標準

完整的成功流程應該是：

1. ✅ 請求重設密碼 → 看到「密碼重設連結已發送」
2. ✅ 收到郵件 → 郵件格式正確，內容完整
3. ✅ 點擊連結 → 重設密碼頁面正常載入
4. ✅ 輸入新密碼 → 即時反饋正常（強度、一致性）
5. ✅ 提交表單 → 看到「密碼重設成功」
6. ✅ 重定向到登入 → 成功訊息顯示
7. ✅ 使用新密碼登入 → 登入成功
8. ✅ 使用舊密碼登入 → 登入失敗（密碼錯誤）

---

## 🎯 下一步

**立即測試**:
1. 重啟應用程式
2. 按照測試步驟完整執行一次
3. 檢查每個步驟的日誌輸出
4. 驗證功能正常運作

**如果遇到問題**:
1. 複製完整的錯誤日誌
2. 檢查資料庫狀態
3. 使用瀏覽器開發者工具檢查請求

---

**文件建立日期**: 2025-11-08  
**版本**: 1.0  
**狀態**: ✅ 已修復，待測試驗證

