<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>管理員訂單管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <style>
        .filter-btn {
            margin-right: 5px;
        }
        .filter-btn.active {
            background-color: #0d6efd;
            color: white;
        }
        .status-badge.PENDING {
            background-color: #ffc107;
            color: #000;
        }
        .status-badge.CONFIRMED {
            background-color: #198754;
            color: white;
        }
        .status-badge.CANCELLED {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>所有訂單</h3>
        <div>
            <button class="btn btn-success me-2" onclick="exportBookings()">
                <i class="bi bi-download"></i> 匯出 Excel
            </button>
            <a href="/admin-dashboard" class="btn btn-secondary me-2">返回儀表板</a>
            <button class="btn btn-primary" onclick="loadBookings()">重新載入</button>
        </div>
    </div>

    <div class="mb-3">
        <div class="btn-group" role="group" aria-label="訂單狀態篩選">
            <button class="btn btn-outline-secondary filter-btn active" data-status="all">全部</button>
            <button class="btn btn-outline-warning filter-btn" data-status="PENDING">待確認</button>
            <button class="btn btn-outline-success filter-btn" data-status="CONFIRMED">已確認</button>
            <button class="btn btn-outline-danger filter-btn" data-status="CANCELLED">已取消</button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>使用者</th>
                <th>住宿名稱</th>
                <th>房型</th>
                <th>入住</th>
                <th>退房</th>
                <th>間數</th>
                <th>總價</th>
                <th>狀態</th>
                <th>動作</th>
            </tr>
            </thead>
            <tbody id="bookings"></tbody>
        </table>
    </div>
</div>

<script>
    // 獲取 CSRF token
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    // 創建通用的 fetch headers
    const getHeaders = () => {
        const headers = { 'Content-Type': 'application/json' };
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }
        return headers;
    };

    let currentBookings = []; // 儲存當前載入的訂單

    // 處理狀態文字顯示
    function getStatusText(status) {
        switch(status) {
            case 'CONFIRMED': return '已確認';
            case 'CANCELLED': return '已取消';
            case 'PENDING':
            default: return '待確認';
        }
    }

    // 顯示訂單列表
    function displayBookings(bookings, filterStatus = 'all') {
        const tbody = document.getElementById("bookings");
        const filteredBookings = filterStatus === 'all'
            ? bookings
            : bookings.filter(b => (b.status || 'PENDING') === filterStatus);

        tbody.innerHTML = filteredBookings.map(b => {
            const status = b.status || 'PENDING';
            return `
                <tr data-status="${status}">
                    <td>${b.id}</td>
                    <td>${b.user?.username || '-'}</td>
                    <td>${b.roomType?.accommodation?.name || '-'}</td>
                    <td>${b.roomType?.name || '-'}</td>
                    <td>${b.checkIn}</td>
                    <td>${b.checkOut}</td>
                    <td>${b.bookedQuantity}</td>
                    <td class="text-success fw-bold">
                        ${b.totalPrice ? 'NT$ ' + Number(b.totalPrice).toLocaleString() : '-'}
                    </td>
                    <td>
                        <span class="badge status-badge ${status}">
                            ${getStatusText(status)}
                        </span>
                    </td>
                    <td>
                        ${getActionButtons(b)}
                    </td>
                </tr>
            `;
        }).join('');

        if (filteredBookings.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center">沒有符合條件的訂單</td>
                </tr>
            `;
        }
    }

    // 獲取操作按鈕
    function getActionButtons(booking) {
        const status = booking.status || 'PENDING';
        if (status === 'CANCELLED') return '';

        let buttons = [];
        if (status === 'PENDING') {
            buttons.push(`<button class="btn btn-success btn-sm me-1" onclick="confirmBooking(${booking.id})">確認訂單</button>`);
        }
        buttons.push(`<button class="btn btn-danger btn-sm" onclick="cancelBooking(${booking.id})">取消訂單</button>`);
        return buttons.join('');
    }

    // 載入訂單
    async function loadBookings() {
        try {
            const res = await fetch("/api/bookings/admin/all", {
                headers: getHeaders(),
                credentials: 'same-origin'
            });
            if (!res.ok) throw new Error('載入失敗');
            currentBookings = await res.json();

            // 使用當前選中的篩選器
            const activeFilter = document.querySelector('.filter-btn.active').dataset.status;
            displayBookings(currentBookings, activeFilter);
        } catch (err) {
            console.error(err);
            alert("載入訂單失敗：" + (err.message || '未知錯誤'));
        }
    }

    // 確認訂單
    async function confirmBooking(id) {
        if (!confirm("確定要確認此訂單嗎？")) return;

        try {
            const res = await fetch(`/api/admin/bookings/${id}/confirm`, {
                method: "POST",
                headers: getHeaders(),
                credentials: 'same-origin'
            });

            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || '確認失敗');
            }

            await loadBookings();
            alert('訂單已確認');
        } catch (err) {
            console.error(err);
            alert(err.message || "確認訂單失敗");
        }
    }

    // 取消訂單
    async function cancelBooking(id) {
        if (!confirm("確定要取消此訂單嗎？")) return;

        try {
            const res = await fetch(`/api/bookings/admin/${id}`, {
                method: "DELETE",
                headers: getHeaders(),
                credentials: 'same-origin'
            });

            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || '取消失敗');
            }

            await loadBookings();
            alert('訂單已取消');
        } catch (err) {
            console.error(err);
            alert(err.message || "取消訂單失敗");
        }
    }

    // 匯出訂單到 Excel
    function exportBookings() {
        const activeFilter = document.querySelector('.filter-btn.active').dataset.status;
        const status = activeFilter !== 'all' ? activeFilter : '';

        let url = '/api/export/bookings';
        const params = new URLSearchParams();
        if (status) {
            params.append('status', status);
        }

        if (params.toString()) {
            url += '?' + params.toString();
        }

        const link = document.createElement('a');
        link.href = url;
        link.download = '';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        const originalText = event.target.innerHTML;
        event.target.innerHTML = '<i class="bi bi-check-circle"></i> 匯出中...';
        event.target.disabled = true;

        setTimeout(() => {
            event.target.innerHTML = originalText;
            event.target.disabled = false;
        }, 2000);
    }

    // 註冊篩選器點擊事件
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // 更新按鈕狀態
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            // 篩選並顯示訂單
            displayBookings(currentBookings, btn.dataset.status);
        });
    });

    // 初始載入
    loadBookings();
</script>
</body>
</html>
