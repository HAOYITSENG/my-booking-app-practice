<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂房系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <style>
        .accommodation-card { transition: transform .2s; }
        .accommodation-card:hover { transform: translateY(-5px); }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="#">訂房系統</a>
        <div class="navbar-nav ms-auto">
            <a href="/user-bookings" class="btn btn-outline-light btn-sm me-2">我的訂單</a>
            <form th:action="@{/logout}" method="post" style="display:inline;">
                <button type="submit" class="btn btn-outline-light btn-sm">登出</button>
            </form>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- 搜尋區域 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header"><h5>住宿搜尋</h5></div>
                <div class="card-body">
                    <label for="locationSearch" class="form-label">地點搜尋</label>
                    <input type="text" class="form-control" id="locationSearch" placeholder="輸入地點 (例: 台北)">
                    <button class="btn btn-primary mt-2" onclick="searchByLocation()">搜尋</button>
                    <button class="btn btn-secondary mt-2" onclick="loadAllAccommodations()">顯示全部</button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header"><h5>日期查詢</h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="checkIn" class="form-label">入住日期</label>
                            <input type="date" class="form-control" id="checkIn">
                        </div>
                        <div class="col-md-6">
                            <label for="checkOut" class="form-label">退房日期</label>
                            <input type="date" class="form-control" id="checkOut">
                        </div>
                    </div>
                    <button class="btn btn-success mt-2" onclick="searchAvailable()">查詢可用住宿</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 住宿列表 -->
    <div class="row">
        <div class="col-12">
            <h3>住宿列表</h3>
            <div id="accommodations" class="row"></div>
        </div>
    </div>
</div>

<!-- 訂房模態框（以房型為單位） -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">確認訂房</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="bookingDetails" class="mb-2"></div>

                <div class="mb-3">
                    <label class="form-label">選擇房型</label>
                    <select id="roomTypeSelect" class="form-select"></select>
                </div>

                <div class="mb-3">
                    <label class="form-label">房間數量</label>
                    <input id="quantity" type="number" class="form-control" value="1" min="1">
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label for="modalCheckIn" class="form-label">入住日期</label>
                        <input type="date" class="form-control" id="modalCheckIn">
                    </div>
                    <div class="col-md-6">
                        <label for="modalCheckOut" class="form-label">退房日期</label>
                        <input type="date" class="form-control" id="modalCheckOut">
                    </div>
                </div>

                <div class="mt-3">
                    <strong>預估總價：</strong>
                    <span id="estimatedTotal" class="text-primary fw-bold">請選擇日期與房型</span>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmBooking()">確認訂房</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let bookingModal;
    let currentAccId = null;
    let roomTypesCache = {}; // accId -> roomTypes
    let selectedPricePerNight = 0;

    document.addEventListener('DOMContentLoaded', () => {
        bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
        loadAllAccommodations();
    });

    function loadAllAccommodations() {
        fetch('/api/accommodations')
            .then(r => r.json())
            .then(displayAccommodations)
            .catch(() => showAlert('載入住宿失敗', 'danger'));
    }

    function searchByLocation() {
        const location = document.getElementById('locationSearch').value.trim();
        if (!location) return showAlert('請輸入搜尋地點', 'warning');

        fetch('/api/accommodations/search?location=' + encodeURIComponent(location))
            .then(r => r.json())
            .then(displayAccommodations)
            .catch(() => showAlert('搜尋失敗', 'danger'));
    }

    function searchAvailable() {
        const checkIn = document.getElementById('checkIn').value;
        const checkOut = document.getElementById('checkOut').value;
        if (!checkIn || !checkOut) return showAlert('請選擇入住和退房日期', 'warning');
        if (checkIn >= checkOut) return showAlert('入住日期必須早於退房日期', 'warning');

        fetch(`/api/accommodations/available?checkIn=${checkIn}&checkOut=${checkOut}`)
            .then(r => r.json())
            .then(displayAccommodations)
            .catch(() => showAlert('查詢失敗', 'danger'));
    }

    function displayAccommodations(list) {
        const c = document.getElementById('accommodations');
        if (!list || list.length === 0) {
            c.innerHTML = '<div class="col-12"><div class="alert alert-info">沒有找到符合條件的住宿</div></div>';
            return;
        }

        c.innerHTML = list.map(acc => `
      <div class="col-md-4 mb-3">
        <div class="card accommodation-card h-100">
          <div class="card-body">
            <h5 class="card-title">${acc.name}</h5>
            <p class="card-text">
              <strong>地點:</strong> ${acc.location}<br>
              <strong>描述:</strong> ${acc.description || ''}<br>
            </p>
            <button class="btn btn-primary" onclick="openBookingModal(${acc.id}, '${escapeHtml(acc.name)}', '${escapeHtml(acc.location)}')">
              查看房型
            </button>
          </div>
        </div>
      </div>
    `).join('');
    }

    function openBookingModal(accId, name, location) {
        currentAccId = accId;
        document.getElementById('bookingDetails').innerHTML = `
      <h6>住宿資訊</h6>
      <p><strong>名稱:</strong> ${name}</p>
      <p><strong>地點:</strong> ${location}</p>
    `;

        // 預設日期帶入查詢區
        document.getElementById('modalCheckIn').value = document.getElementById('checkIn').value;
        document.getElementById('modalCheckOut').value = document.getElementById('checkOut').value;

        // 載入房型
        loadRoomTypes(accId).then(() => {
            bookingModal.show();
            updateEstimatedTotal();
        });

        // 綁定變更事件
        ['modalCheckIn','modalCheckOut','roomTypeSelect','quantity'].forEach(id => {
            document.getElementById(id).onchange = updateEstimatedTotal;
            document.getElementById(id).oninput = updateEstimatedTotal;
        });
    }

    function loadRoomTypes(accId) {
        if (roomTypesCache[accId]) {
            fillRoomTypeSelect(roomTypesCache[accId]);
            return Promise.resolve();
        }
        return fetch(`/api/room-types/by-accommodation/${accId}`, {
            headers: getHeaders(),
            credentials: 'same-origin'
        })
            .then(r => r.json())
            .then(list => {
                roomTypesCache[accId] = list;
                fillRoomTypeSelect(list);
            })
            .catch(() => showAlert('載入房型失敗', 'danger'));
    }

    function fillRoomTypeSelect(list) {
        const sel = document.getElementById('roomTypeSelect');
        if (!list || list.length === 0) {
            sel.innerHTML = '<option value="">此住宿尚無房型</option>';
            selectedPricePerNight = 0;
            return;
        }
        sel.innerHTML = list.map(rt =>
            `<option value="${rt.id}" data-price="${rt.pricePerNight}">${rt.name}｜NT$ ${rt.pricePerNight}｜庫存 ${rt.totalRooms}</option>`
        ).join('');
        selectedPricePerNight = Number(sel.options[sel.selectedIndex].dataset.price || 0);
    }

    function updateEstimatedTotal() {
        const sel = document.getElementById('roomTypeSelect');
        if (!sel || !sel.value) {
            document.getElementById('estimatedTotal').textContent = '請選擇房型';
            return;
        }
        selectedPricePerNight = Number(sel.options[sel.selectedIndex].dataset.price || 0);

        const checkIn = document.getElementById('modalCheckIn').value;
        const checkOut = document.getElementById('modalCheckOut').value;
        const qty = Math.max(1, Number(document.getElementById('quantity').value || 1));

        if (checkIn && checkOut && checkIn < checkOut) {
            const nights = calculateDays(checkIn, checkOut);
            const total = selectedPricePerNight * nights * qty;
            document.getElementById('estimatedTotal').textContent =
                `NT$ ${Number(total).toLocaleString()}（${nights} 晚 × ${qty} 間）`;
        } else {
            document.getElementById('estimatedTotal').textContent = '請選擇有效日期';
        }
    }

    function confirmBooking() {
        const roomTypeId = document.getElementById('roomTypeSelect').value;
        const quantity = Math.max(1, Number(document.getElementById('quantity').value || 1));
        const checkIn = document.getElementById('modalCheckIn').value;
        const checkOut = document.getElementById('modalCheckOut').value;

        if (!roomTypeId) return showAlert('請選擇房型', 'warning');
        if (!checkIn || !checkOut) return showAlert('請選擇入住和退房日期', 'warning');
        if (checkIn >= checkOut) return showAlert('入住日期必須早於退房日期', 'warning');

        fetch(`/api/bookings/by-room-type?roomTypeId=${roomTypeId}&checkIn=${checkIn}&checkOut=${checkOut}&quantity=${quantity}`, {
            method: 'POST',
            headers: getHeaders(),
            credentials: 'same-origin'
        })
            .then(res => {
                if (res.ok) return res.json();
                return res.text().then(t => { throw new Error(t || '訂房失敗'); });
            })
            .then(() => {
                bookingModal.hide();
                showAlert('訂房成功，可至「我的訂單」查看訂房紀錄', 'success');
            })
            .catch(e => showAlert(e.message, 'danger'));
    }

    // 獲取 CSRF token
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    // 創建通用的 fetch headers
    const getHeaders = () => {
        const headers = { 'Content-Type': 'application/json' };
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }
        return headers;
    };

    function calculateDays(checkIn, checkOut) {
        const s = new Date(checkIn);
        const e = new Date(checkOut);
        const ms = e - s;
        if (isNaN(ms) || ms <= 0) return 0;
        return Math.ceil(ms / (1000*60*60*24));
    }

    function showAlert(message, type) {
        const div = document.createElement('div');
        div.className = `alert alert-${type} alert-dismissible fade show`;
        div.innerHTML = `${escapeHtml(message)}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        const container = document.querySelector('.container');
        container.insertBefore(div, container.firstElementChild);
        setTimeout(() => div.remove(), 5000);
    }

    function escapeHtml(s) {
        return String(s || '')
            .replace(/&/g,'&amp;').replace(/</g,'&lt;')
            .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
</script>
</body>
</html>
